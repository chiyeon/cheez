<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Woodstock</title>

   <link rel="stylesheet" href="style.css">
</head>
<body>
   <div id="loading-hint">
      <p>Loading...</p>
   </div>
   
   <main>
      <div id="status-box" class="hidden">
         <span class="status-background"></span>
         
         <div class="status-window">
            <h1 id="status"></h1>
            <button id="status-close-button">Close</button>
         </div>
      </div>
      <div id="board"></div>

      <div id="game-export" class="hidden">
         <input placeholder="Name" id="game-export-name" />
         <p>By pressing 'submit' below, you are sending a record of this chess game to me in standard PGN format. This is purely for fun and isn't required, nor does it carry any sensitive data.</p>
         <button id="game-export-button">Submit</button>
         <button id="game-export-cancel-button">Cancel</button>
      </div>

      <div class="options">
         <button id="undo-button">Undo</button>
         <button id="ai-move-button">Switch</button>
         <button id="flip-board-button">Flip</button>
         <button id="reset-button">Reset</button>
         <button id="export-button">Export</button>
         <select name="theme" id="theme-select">
            <option value="john_pablok_improved" selected>John Pablok Improved</option>
            <option value="wikipedia">Wikipedia</option>
            <option value="pixels">Pixelated</option>
            <option value="chalked">Chalked</option>
         </select>
         <input type="text" placeholder="FEN String" id="fen-input" />
         <button id="load-fen-button">Load</button>
      </div>

      <!--div class="about">
         <h1>About</h1>
         <p>Woodstock is a chess engine and AI opponent written in C++, exported to WebAssembly with Emscripten. Woodstock is currently a massive work in progress and may have issues. Currently, the bot looks up to 6 steps in the future using standard Negamaxing with Alpha Beta pruning. It can play as white or black, and you can load any valid FEN string to start from. Games can also be exported with PGN format, printed to the browser's console.</p>
      </div-->
   </main>

   <script src="index.js"></script>
   <script src="board.js"></script>
   <script>
      const set_board = (b) => {
         board.set_board(b)
         board.update_chessboard()
      }

      const hide_loading_hint = () => {
         document.querySelector("#loading-hint").classList.add("hidden");
      }

      var make_ai_move;
      var update_pgn;
      var set_status;

      let board = new Chessboard("board");
      let pgn = "";

      let undo_button_el = document.querySelector("#undo-button")
      let ai_button_el = document.querySelector("#ai-move-button");
      let flip_button_el = document.querySelector("#flip-board-button");
      let load_fen_el = document.querySelector("#load-fen-button");
      let fen_input_el = document.querySelector("#fen-input");
      let export_submit_button_el = document.querySelector("#game-export-button");
      let name_input_el = document.querySelector("#game-export-name");
      let reset_button_el = document.querySelector("#reset-button");
      let export_button_el = document.querySelector("#export-button");
      let game_export_el = document.querySelector("#game-export");
      let status_el = document.querySelector("#status");
      let status_box_el = document.querySelector("#status-box");
      let status_close_button_el = document.querySelector("#status-close-button");

      status_close_button_el.addEventListener("click", () => {
         status_box_el.classList.add("hidden");
      })

      document.querySelector("#theme-select").addEventListener("change", (e) => {
         board.theme = e.target.value;
         board.update_chessboard();
      })

      document.addEventListener("DOMContentLoaded", async () => {
         const woodstock = await WoodstockModule();

         undo_button_el.addEventListener("click", () => {
            woodstock.ccall(
               "undo",
               null,
               null,
               null
            )
         })

         ai_button_el.addEventListener("click", () => {
            woodstock.ccall(
               "switch_sides", // name of C function
               null, // return type
               null, // argument types
               null, // arguments
            );
         })

         flip_button_el.addEventListener("click", () => {
            board.flip();
         })

         load_fen_el.addEventListener("click", () => {
            let fen_str = fen_input_el.value;
            let buffer = woodstock._malloc(fen_str.length + 1);
            woodstock.stringToUTF8(fen_str, buffer, fen_str.length + 1);
            woodstock.ccall("load_fen", null, [ "number" ], [ buffer ]);
            woodstock._free(buffer);
         })

         reset_button_el.addEventListener("click", () => {
            woodstock.ccall("reset_game", null, null, null);
         })

         export_button_el.addEventListener("click", () => {
            game_export_el.classList.remove("hidden");
         })

         document.querySelector("#game-export-cancel-button").addEventListener("click", () => {
            game_export_el.classList.add("hidden");
         })

         export_submit_button_el.addEventListener("click", () => {
            let name_str = name_input_el.value;
            let buffer = woodstock._malloc(name_str.length + 1);

            woodstock.stringToUTF8(name_str, buffer, name_str.length + 1);
            woodstock.ccall("set_pgn", null, [], [buffer]);
            woodstock._free(buffer);

         })

         update_pgn = (ptr, len) => {
            pgn = woodstock.UTF8ToString(ptr, len);
            console.log(pgn);
         }

         set_status = (s) => {
            switch(s) {
               case 0:
                  status_el.innerHTML = "Draw.";
                  document.querySelector(".king.black").classList.add("draw");
                  document.querySelector(".king.white").classList.add("draw");
                  status_box_el.classList.remove("hidden");
                  break;
               case 1:
                  status_el.innerHTML = "White Wins!";
                  document.querySelector(".king.black").classList.add("checkmated");
                  status_box_el.classList.remove("hidden");
                  break;
               case 2:
                  status_el.innerHTML = "Black Wins!";
                  document.querySelector(".king.white").classList.add("checkmated");
                  status_box_el.classList.remove("hidden");
                  break;
               case 4:
                  document.querySelector(".king.white").classList.add("checked");
                  break;
               case 5:
                  document.querySelector(".king.black").classList.add("checked");
                  break;
               default:
                  status_el.innerHTML = "";
                  status_box_el.classList.add("hidden");
                  break;
            }
         }

         make_ai_move = () => {
            setTimeout(() => {
               woodstock.ccall(
               "make_best_move", // name of C function
               null, // return type
               null, // argument types
               null, // arguments
            );
            }, 10)
         }

         for (let i = 0; i < 64; i++) {
            let square = document.getElementById(`sq-${i}`)
            square.addEventListener("click", () => {
               woodstock.ccall(
                  "click_square",
                  null,
                  [ "number" ],
                  [ board.flipped ? 63 - i : i ]
               )
            })
         }
      });
   </script>
   {{{ SCRIPT }}}
</body>
</html>
