<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Woodstock</title>

   <link rel="stylesheet" href="style.css">
</head>
<body>
   <div id="loading-hint">
      <p>Loading...</p>
   </div>
   
   <main>
      <div id="board"></div>

      <div class="options">
         <button id="undo-button">Undo</button>
         <button id="ai-move-button">AI Move</button>
         <button id="flip-board-button">Flip</button>
         <select name="theme" id="theme-select">
            <option value="john_pablok_improved" selected>John Pablok Improved</option>
            <option value="wikipedia">Wikipedia</option>
            <option value="pixels">Pixelated</option>
         </select>
         <input type="text" placeholder="FEN String" id="fen-input" />
         <button id="load-fen-button">Load</button>
      </div>
   </main>

   <script src="index.js"></script>
   <script src="board.js"></script>
   <script>
      const set_board = (b) => {
         board.set_board(b)
         board.update_chessboard()
      }

      const hide_loading_hint = () => {
         document.querySelector("#loading-hint").classList.add("hidden");
      }

      var make_ai_move;

      let board = new Chessboard("board");

      let undo_button_el = document.querySelector("#undo-button")
      let ai_button_el = document.querySelector("#ai-move-button");
      let flip_button_el = document.querySelector("#flip-board-button");
      let load_fen_el = document.querySelector("#load-fen-button");
      let fen_input_el = document.querySelector("#fen-input")

      document.querySelector("#theme-select").addEventListener("change", (e) => {
         board.theme = e.target.value;
         board.update_chessboard();
      })

      document.addEventListener("DOMContentLoaded", async () => {
         const woodstock = await WoodstockModule();

         undo_button_el.addEventListener("click", () => {
            woodstock.ccall(
               "undo",
               null,
               null,
               null
            )
         })

         ai_button_el.addEventListener("click", () => {
            woodstock.ccall(
               "make_best_move", // name of C function
               null, // return type
               null, // argument types
               null, // arguments
            );
         })

         flip_button_el.addEventListener("click", () => {
            board.flip();
         })

         load_fen_el.addEventListener("click", () => {
            let fen_str = fen_input_el.value;
            let buffer = woodstock._malloc(fen_str.length + 1);
            woodstock.stringToUTF8(fen_str, buffer, fen_str.length + 1);
            woodstock.ccall("load_fen", null, [ "number" ], [ buffer ]);
            woodstock._free(buffer);
         })

         make_ai_move = () => {
            setTimeout(() => {
               woodstock.ccall(
               "make_best_move", // name of C function
               null, // return type
               null, // argument types
               null, // arguments
            );
            }, 10)
         }

         for (let i = 0; i < 64; i++) {
            let square = document.getElementById(`sq-${i}`)
            square.addEventListener("click", () => {
               woodstock.ccall(
                  "click_square",
                  null,
                  [ "number" ],
                  [ board.flipped ? 63 - i : i ]
               )
            })
         }
      });
   </script>
   {{{ SCRIPT }}}
</body>
</html>